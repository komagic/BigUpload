<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BigUpload ä¸‰åç«¯æœåŠ¡æµ‹è¯•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .backend-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .backend-option {
        padding: 15px 30px;
        border: 2px solid #ddd;
        border-radius: 50px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        position: relative;
      }

      .backend-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .backend-option.active {
        background: #4ecdc4;
        color: white;
        border-color: #4ecdc4;
      }

      .backend-option.nodejs {
        border-color: #68d391;
      }
      .backend-option.python {
        border-color: #4fd1c7;
      }
      .backend-option.java {
        border-color: #f56565;
      }

      .backend-option.nodejs.active {
        background: #68d391;
        border-color: #68d391;
      }
      .backend-option.python.active {
        background: #4fd1c7;
        border-color: #4fd1c7;
      }
      .backend-option.java.active {
        background: #f56565;
        border-color: #f56565;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        background: #ddd;
      }

      .status-indicator.online {
        background: #48bb78;
      }
      .status-indicator.offline {
        background: #f56565;
      }
      .status-indicator.loading {
        background: #ed8936;
      }

      .upload-area {
        border: 3px dashed #ddd;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        transition: all 0.3s ease;
        margin-bottom: 30px;
        cursor: pointer;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #4ecdc4;
        background: #f8fdff;
      }

      .upload-area.dragover {
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 4em;
        color: #ddd;
        margin-bottom: 20px;
      }

      .upload-area:hover .upload-icon,
      .upload-area.dragover .upload-icon {
        color: #4ecdc4;
      }

      .upload-text {
        font-size: 1.2em;
        color: #666;
        margin-bottom: 10px;
      }

      .upload-hint {
        color: #999;
        font-size: 0.9em;
      }

      .file-input {
        display: none;
      }

      .progress-container {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .progress-text {
        text-align: center;
        font-weight: 600;
        color: #495057;
      }

      .upload-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .info-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .info-number {
        font-size: 2em;
        font-weight: bold;
        color: #4ecdc4;
        margin-bottom: 5px;
      }

      .info-label {
        color: #666;
        font-size: 0.9em;
      }

      .log-container {
        margin-top: 30px;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-title {
        color: #4ecdc4;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .log-entry {
        color: #ccc;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.5;
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .log-entry.info {
        background: rgba(78, 205, 196, 0.1);
        color: #4ecdc4;
      }
      .log-entry.success {
        background: rgba(72, 187, 120, 0.1);
        color: #48bb78;
      }
      .log-entry.error {
        background: rgba(245, 101, 101, 0.1);
        color: #f56565;
      }
      .log-entry.warning {
        background: rgba(237, 137, 54, 0.1);
        color: #ed8936;
      }

      .service-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .service-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #ddd;
      }

      .service-card.nodejs {
        border-left-color: #68d391;
      }
      .service-card.python {
        border-left-color: #4fd1c7;
      }
      .service-card.java {
        border-left-color: #f56565;
      }

      .service-name {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 10px;
      }

      .service-url {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .service-info {
        color: #999;
        font-size: 0.8em;
      }

      .btn {
        background: #4ecdc4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        background: #44a08d;
        transform: translateY(-2px);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .status-indicator.loading {
        animation: pulse 1.5s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸš€ BigUpload</h1>
        <p>ä¼ä¸šçº§å¤§æ–‡ä»¶ä¸Šä¼ è§£å†³æ–¹æ¡ˆ - ä¸‰åç«¯æœåŠ¡æµ‹è¯•</p>
      </div>

      <div class="content">
        <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
        <div class="service-status" id="serviceStatus">
          <div class="service-card nodejs" id="nodejsCard">
            <div class="service-name">
              <span class="status-indicator loading" id="nodejsStatus"></span>
              Node.js æœåŠ¡
            </div>
            <div class="service-url">http://localhost:3000</div>
            <div class="service-info" id="nodejsInfo">æ£€æŸ¥ä¸­...</div>
          </div>

          <div class="service-card python" id="pythonCard">
            <div class="service-name">
              <span class="status-indicator loading" id="pythonStatus"></span>
              Python æœåŠ¡
            </div>
            <div class="service-url">http://localhost:5000</div>
            <div class="service-info" id="pythonInfo">æ£€æŸ¥ä¸­...</div>
          </div>

          <div class="service-card java" id="javaCard">
            <div class="service-name">
              <span class="status-indicator loading" id="javaStatus"></span>
              Java æœåŠ¡
            </div>
            <div class="service-url">http://localhost:8080</div>
            <div class="service-info" id="javaInfo">æ£€æŸ¥ä¸­...</div>
          </div>
        </div>

        <!-- åç«¯é€‰æ‹©å™¨ -->
        <div class="backend-selector">
          <div class="backend-option nodejs" data-backend="nodejs">
            <span class="status-indicator" id="indicator-nodejs"></span>
            Node.js Express
          </div>
          <div class="backend-option python" data-backend="python">
            <span class="status-indicator" id="indicator-python"></span>
            Python FastAPI
          </div>
          <div class="backend-option java" data-backend="java">
            <span class="status-indicator" id="indicator-java"></span>
            Java Spring Boot
          </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
          <div class="upload-hint">æ”¯æŒä»»æ„æ–‡ä»¶ç±»å‹ï¼Œæ¨èæµ‹è¯•å¤§æ–‡ä»¶(>10MB)</div>
          <input type="file" class="file-input" id="fileInput" multiple />
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">å‡†å¤‡ä¸Šä¼ ...</div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="upload-info" id="uploadInfo" style="display: none">
          <div class="info-card">
            <div class="info-number" id="fileCount">0</div>
            <div class="info-label">æ–‡ä»¶æ•°é‡</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="totalSize">0</div>
            <div class="info-label">æ€»å¤§å°</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="uploadSpeed">0</div>
            <div class="info-label">ä¸Šä¼ é€Ÿåº¦</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="remainingTime">--</div>
            <div class="info-label">å‰©ä½™æ—¶é—´</div>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div style="text-align: center; margin: 20px 0">
          <button class="btn" id="testAllBtn">ğŸ”¬ æµ‹è¯•æ‰€æœ‰æœåŠ¡</button>
          <button class="btn" id="refreshBtn">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
          <button class="btn" id="clearLogsBtn">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- æ—¥å¿—å®¹å™¨ -->
        <div class="log-container">
          <div class="log-title">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
          <div id="logContent"></div>
        </div>
      </div>
    </div>

    <script>
      class BigUploadTester {
        constructor() {
          this.backends = {
            nodejs: {
              name: 'Node.js Express',
              url: 'http://localhost:3000',
              endpoints: {
                health: '/',
                verify: '/verify',
                upload: '/upload-chunk',
                merge: '/merge-chunks'
              }
            },
            python: {
              name: 'Python FastAPI',
              url: 'http://localhost:5000',
              endpoints: {
                health: '/api/upload/health',
                verify: '/api/upload/verify',
                upload: '/api/upload/upload',
                merge: '/api/upload/merge'
              }
            },
            java: {
              name: 'Java Spring Boot',
              url: 'http://localhost:8080',
              endpoints: {
                health: '/api/upload/health',
                verify: '/api/upload/verify',
                upload: '/api/upload/upload',
                merge: '/api/upload/merge'
              }
            }
          }

          this.currentBackend = 'nodejs'
          this.chunkSize = 2 * 1024 * 1024 // 2MB
          this.maxConcurrency = 3
          this.uploadStats = {
            startTime: 0,
            bytesUploaded: 0,
            totalBytes: 0,
            actualUploadStart: 0, // å®é™…å¼€å§‹ä¼ è¾“çš„æ—¶é—´
            lastUpdateTime: 0, // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
            lastBytes: 0, // ä¸Šæ¬¡æ›´æ–°æ—¶çš„å­—èŠ‚æ•°
            speedHistory: [] // é€Ÿåº¦å†å²è®°å½•ï¼ˆç”¨äºå¹³æ»‘è®¡ç®—ï¼‰
          }

          this.init()
        }

        init() {
          this.bindEvents()
          this.checkAllServices()
          this.selectBackend('nodejs')
        }

        bindEvents() {
          // æ–‡ä»¶é€‰æ‹©
          const fileInput = document.getElementById('fileInput')
          const uploadArea = document.getElementById('uploadArea')

          uploadArea.addEventListener('click', () => fileInput.click())
          fileInput.addEventListener('change', e =>
            this.handleFiles(e.target.files)
          )

          // æ‹–æ‹½ä¸Šä¼ 
          uploadArea.addEventListener('dragover', e => {
            e.preventDefault()
            uploadArea.classList.add('dragover')
          })

          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover')
          })

          uploadArea.addEventListener('drop', e => {
            e.preventDefault()
            uploadArea.classList.remove('dragover')
            this.handleFiles(e.dataTransfer.files)
          })

          // åç«¯é€‰æ‹©
          document.querySelectorAll('.backend-option').forEach(option => {
            option.addEventListener('click', () => {
              this.selectBackend(option.dataset.backend)
            })
          })

          // æŒ‰é’®äº‹ä»¶
          document
            .getElementById('testAllBtn')
            .addEventListener('click', () => this.testAllServices())
          document
            .getElementById('refreshBtn')
            .addEventListener('click', () => this.checkAllServices())
          document
            .getElementById('clearLogsBtn')
            .addEventListener('click', () => this.clearLogs())
        }

        selectBackend(backend) {
          this.currentBackend = backend

          // æ›´æ–°UI
          document.querySelectorAll('.backend-option').forEach(option => {
            option.classList.remove('active')
          })
          document
            .querySelector(`[data-backend="${backend}"]`)
            .classList.add('active')

          this.log(`åˆ‡æ¢åˆ° ${this.backends[backend].name}`, 'info')
        }

        async checkAllServices() {
          this.log('å¼€å§‹æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€...', 'info')

          for (const [key, backend] of Object.entries(this.backends)) {
            await this.checkService(key, backend)
          }

          this.log('æœåŠ¡çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success')
        }

        async checkService(key, backend) {
          const statusElement = document.getElementById(`${key}Status`)
          const infoElement = document.getElementById(`${key}Info`)
          const indicatorElement = document.getElementById(`indicator-${key}`)

          try {
            statusElement.className = 'status-indicator loading'
            indicatorElement.className = 'status-indicator loading'
            infoElement.textContent = 'æ£€æŸ¥ä¸­...'

            const response = await fetch(backend.url + backend.endpoints.health)

            if (response.ok) {
              const data = await response.json()
              statusElement.className = 'status-indicator online'
              indicatorElement.className = 'status-indicator online'
              infoElement.textContent = `âœ… åœ¨çº¿ - ${
                data.name || data.service || 'æœåŠ¡æ­£å¸¸'
              }`
              this.log(`${backend.name} æœåŠ¡æ­£å¸¸`, 'success')
            } else {
              throw new Error(`HTTP ${response.status}`)
            }
          } catch (error) {
            statusElement.className = 'status-indicator offline'
            indicatorElement.className = 'status-indicator offline'
            infoElement.textContent = `âŒ ç¦»çº¿ - ${error.message}`
            this.log(`${backend.name} æœåŠ¡ç¦»çº¿: ${error.message}`, 'error')
          }
        }

        async testAllServices() {
          this.log('å¼€å§‹æµ‹è¯•æ‰€æœ‰æœåŠ¡çš„APIç«¯ç‚¹...', 'info')

          for (const [key, backend] of Object.entries(this.backends)) {
            await this.testServiceEndpoints(key, backend)
          }

          this.log('æ‰€æœ‰æœåŠ¡æµ‹è¯•å®Œæˆ', 'success')
        }

        async testServiceEndpoints(key, backend) {
          this.log(`æµ‹è¯• ${backend.name} çš„APIç«¯ç‚¹...`, 'info')

          // æµ‹è¯•å¥åº·æ£€æŸ¥
          try {
            const healthResponse = await fetch(
              backend.url + backend.endpoints.health
            )
            if (healthResponse.ok) {
              this.log(`  âœ… å¥åº·æ£€æŸ¥ OK`, 'success')
            } else {
              this.log(`  âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`, 'error')
            }
          } catch (error) {
            this.log(`  âŒ å¥åº·æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error')
          }

          // æµ‹è¯•æ–‡ä»¶éªŒè¯ç«¯ç‚¹
          try {
            const verifyData = {
              filename: 'test.txt',
              fileHash: 'test-hash-123',
              fileSize: 1024
            }

            const verifyResponse = await fetch(
              backend.url + backend.endpoints.verify,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(verifyData)
              }
            )

            if (
              verifyResponse.status === 200 ||
              verifyResponse.status === 404
            ) {
              this.log(`  âœ… æ–‡ä»¶éªŒè¯ç«¯ç‚¹ OK`, 'success')
            } else {
              this.log(`  âŒ æ–‡ä»¶éªŒè¯å¤±è´¥: ${verifyResponse.status}`, 'warning')
            }
          } catch (error) {
            this.log(`  âŒ æ–‡ä»¶éªŒè¯é”™è¯¯: ${error.message}`, 'error')
          }
        }

        async handleFiles(files) {
          if (files.length === 0) return

          this.log(`é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`, 'info')

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          const totalSize = Array.from(files).reduce(
            (sum, file) => sum + file.size,
            0
          )
          this.updateUploadInfo(files.length, totalSize)

          // å¼€å§‹ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡ä»¶
          if (files.length > 0) {
            await this.uploadFile(files[0])
          }
        }

        async uploadFile(file) {
          const backend = this.backends[this.currentBackend]
          this.log(
            `å¼€å§‹ä¸Šä¼ æ–‡ä»¶: ${file.name} (${this.formatBytes(file.size)}) åˆ° ${
              backend.name
            }`,
            'info'
          )

          // æ˜¾ç¤ºè¿›åº¦æ¡
          document.getElementById('progressContainer').style.display = 'block'
          this.uploadStats.startTime = Date.now()
          this.uploadStats.bytesUploaded = 0
          this.uploadStats.totalBytes = file.size

          try {
            // è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
            this.updateProgress(0, 'è®¡ç®—æ–‡ä»¶å“ˆå¸Œ...')
            const fileHash = await this.calculateFileHash(file)
            this.log(`æ–‡ä»¶å“ˆå¸Œ: ${fileHash}`, 'info')

            // éªŒè¯æ–‡ä»¶
            this.updateProgress(5, 'éªŒè¯æ–‡ä»¶...')
            const verifyResult = await this.verifyFile(
              file.name,
              fileHash,
              file.size
            )

            if (verifyResult.exists) {
              this.updateProgress(100, 'æ–‡ä»¶å·²å­˜åœ¨ï¼Œç§’ä¼ æˆåŠŸï¼')
              this.log('æ–‡ä»¶å·²å­˜åœ¨ï¼Œç§’ä¼ æˆåŠŸï¼', 'success')
              return
            }

            // åˆ†ç‰‡ä¸Šä¼ 
            const chunks = Math.ceil(file.size / this.chunkSize)
            this.log(`æ–‡ä»¶å°†åˆ†ä¸º ${chunks} ä¸ªåˆ†ç‰‡`, 'info')

            // é‡ç½®ä¸Šä¼ ç»Ÿè®¡ï¼ˆæ’é™¤å“ˆå¸Œè®¡ç®—æ—¶é—´ï¼‰
            this.uploadStats.actualUploadStart = 0
            this.uploadStats.lastUpdateTime = 0
            this.uploadStats.lastBytes = 0
            this.uploadStats.speedHistory = []

            for (let i = 0; i < chunks; i++) {
              const start = i * this.chunkSize
              const end = Math.min(start + this.chunkSize, file.size)
              const chunk = file.slice(start, end)

              this.updateProgress(
                ((i + 1) / chunks) * 90 + 5,
                `ä¸Šä¼ åˆ†ç‰‡ ${i + 1}/${chunks}...`
              )

              await this.uploadChunk(chunk, i, fileHash, file.name, chunks)

              this.uploadStats.bytesUploaded += chunk.size
              this.updateUploadSpeed()
            }

            // åˆå¹¶åˆ†ç‰‡
            this.updateProgress(98, 'åˆå¹¶åˆ†ç‰‡...')
            await this.mergeChunks(fileHash, file.name, chunks, file.size)

            this.updateProgress(100, 'ä¸Šä¼ å®Œæˆï¼')
            this.log(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸï¼`, 'success')
          } catch (error) {
            this.log(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error')
            this.updateProgress(0, `ä¸Šä¼ å¤±è´¥: ${error.message}`)
          }
        }

        async calculateFileHash(file) {
          const hashBuffer = await crypto.subtle.digest(
            'SHA-256',
            await file.arrayBuffer()
          )
          const hashArray = Array.from(new Uint8Array(hashBuffer))
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        async verifyFile(filename, fileHash, fileSize) {
          const backend = this.backends[this.currentBackend]
          const response = await fetch(backend.url + backend.endpoints.verify, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, fileHash, fileSize })
          })

          if (response.ok) {
            return await response.json()
          } else {
            return { exists: false, uploadedChunks: [] }
          }
        }

        async uploadChunk(chunk, chunkIndex, fileHash, filename, totalChunks) {
          const backend = this.backends[this.currentBackend]
          const formData = new FormData()

          formData.append('chunk', chunk)
          formData.append('chunkIndex', chunkIndex.toString())
          formData.append('fileHash', fileHash)

          // Java åç«¯éœ€è¦ç‰¹æ®Šå‚æ•°
          if (this.currentBackend === 'java') {
            formData.append('fileName', filename)
            formData.append('fileId', fileHash) // ä½¿ç”¨ fileHash ä½œä¸º fileId
            formData.append('chunkTotal', totalChunks.toString())
          } else {
            formData.append('filename', filename)
          }

          const response = await fetch(backend.url + backend.endpoints.upload, {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error(`åˆ†ç‰‡ ${chunkIndex} ä¸Šä¼ å¤±è´¥: ${response.status}`)
          }

          return await response.json()
        }

        async mergeChunks(fileHash, filename, totalChunks, fileSize) {
          const backend = this.backends[this.currentBackend]

          let requestBody
          if (this.currentBackend === 'java') {
            // Java åç«¯éœ€è¦ç‰¹æ®Šå‚æ•°æ ¼å¼
            requestBody = {
              fileId: fileHash, // ä½¿ç”¨ fileHash ä½œä¸º fileId
              fileName: filename,
              fileHash: fileHash,
              chunkTotal: totalChunks,
              fileSize: fileSize
            }
          } else {
            // Node.js å’Œ Python åç«¯
            requestBody = {
              fileHash,
              filename,
              totalChunks
            }
          }

          const response = await fetch(backend.url + backend.endpoints.merge, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          })

          if (!response.ok) {
            throw new Error(`åˆ†ç‰‡åˆå¹¶å¤±è´¥: ${response.status}`)
          }

          return await response.json()
        }

        updateProgress(percent, text) {
          document.getElementById('progressFill').style.width = `${percent}%`
          document.getElementById('progressText').textContent = text
        }

        updateUploadInfo(fileCount, totalSize) {
          document.getElementById('uploadInfo').style.display = 'grid'
          document.getElementById('fileCount').textContent = fileCount
          document.getElementById('totalSize').textContent =
            this.formatBytes(totalSize)
        }

        updateUploadSpeed() {
          const now = Date.now()

          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œè®°å½•å®é™…å¼€å§‹ä¼ è¾“æ—¶é—´
          if (this.uploadStats.actualUploadStart === 0) {
            this.uploadStats.actualUploadStart = now
            this.uploadStats.lastUpdateTime = now
            this.uploadStats.lastBytes = 0
            return
          }

          // è®¡ç®—ç¬æ—¶é€Ÿåº¦ï¼ˆè¿‡å»1ç§’å†…çš„é€Ÿåº¦ï¼‰
          const timeDiff = (now - this.uploadStats.lastUpdateTime) / 1000
          const bytesDiff =
            this.uploadStats.bytesUploaded - this.uploadStats.lastBytes

          if (timeDiff > 0) {
            const instantSpeed = bytesDiff / timeDiff

            // å°†ç¬æ—¶é€Ÿåº¦åŠ å…¥å†å²è®°å½•ï¼ˆä¿æŒæœ€è¿‘5ä¸ªè®°å½•ï¼‰
            this.uploadStats.speedHistory.push(instantSpeed)
            if (this.uploadStats.speedHistory.length > 5) {
              this.uploadStats.speedHistory.shift()
            }

            // è®¡ç®—å¹³æ»‘é€Ÿåº¦ï¼ˆæœ€è¿‘å‡ æ¬¡çš„å¹³å‡å€¼ï¼‰
            const avgSpeed =
              this.uploadStats.speedHistory.reduce(
                (sum, speed) => sum + speed,
                0
              ) / this.uploadStats.speedHistory.length

            // è®¡ç®—å‰©ä½™æ—¶é—´
            const remaining =
              avgSpeed > 0
                ? (this.uploadStats.totalBytes -
                    this.uploadStats.bytesUploaded) /
                  avgSpeed
                : Infinity

            // æ›´æ–°UI
            document.getElementById('uploadSpeed').textContent =
              this.formatBytes(avgSpeed) + '/s'
            document.getElementById('remainingTime').textContent =
              this.formatTime(remaining)

            // æ›´æ–°è®°å½•
            this.uploadStats.lastUpdateTime = now
            this.uploadStats.lastBytes = this.uploadStats.bytesUploaded

            // è°ƒè¯•æ—¥å¿—ï¼ˆæ¯5æ¬¡æ›´æ–°è¾“å‡ºä¸€æ¬¡ï¼‰
            if (this.uploadStats.speedHistory.length === 5) {
              this.log(
                `å®æ—¶é€Ÿåº¦: ${this.formatBytes(avgSpeed)}/s (åŸºäºæœ€è¿‘${
                  this.uploadStats.speedHistory.length
                }æ¬¡æµ‹é‡)`,
                'info'
              )
            }
          }
        }

        formatBytes(bytes) {
          if (bytes === 0) return '0 B'
          const k = 1024
          const sizes = ['B', 'KB', 'MB', 'GB']
          const i = Math.floor(Math.log(bytes) / Math.log(k))
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
          )
        }

        formatTime(seconds) {
          if (!isFinite(seconds)) return '--'
          const mins = Math.floor(seconds / 60)
          const secs = Math.floor(seconds % 60)
          return `${mins}:${secs.toString().padStart(2, '0')}`
        }

        log(message, type = 'info') {
          const logContent = document.getElementById('logContent')
          const timestamp = new Date().toLocaleTimeString()
          const logEntry = document.createElement('div')
          logEntry.className = `log-entry ${type}`
          logEntry.textContent = `[${timestamp}] ${message}`
          logContent.appendChild(logEntry)
          logContent.scrollTop = logContent.scrollHeight
        }

        clearLogs() {
          document.getElementById('logContent').innerHTML = ''
          this.log('æ—¥å¿—å·²æ¸…ç©º', 'info')
        }
      }

      // åˆå§‹åŒ–æµ‹è¯•å™¨
      window.addEventListener('DOMContentLoaded', () => {
        new BigUploadTester()
      })
    </script>
  </body>
</html>
