<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BigUpload ‰∏âÂêéÁ´ØÊúçÂä°ÊµãËØï</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .backend-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .backend-option {
        padding: 15px 30px;
        border: 2px solid #ddd;
        border-radius: 50px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        position: relative;
      }

      .backend-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .backend-option.active {
        background: #4ecdc4;
        color: white;
        border-color: #4ecdc4;
      }

      .backend-option.nodejs {
        border-color: #68d391;
      }
      .backend-option.python {
        border-color: #4fd1c7;
      }
      .backend-option.java {
        border-color: #f56565;
      }

      .backend-option.nodejs.active {
        background: #68d391;
        border-color: #68d391;
      }
      .backend-option.python.active {
        background: #4fd1c7;
        border-color: #4fd1c7;
      }
      .backend-option.java.active {
        background: #f56565;
        border-color: #f56565;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        background: #ddd;
      }

      .status-indicator.online {
        background: #48bb78;
      }
      .status-indicator.offline {
        background: #f56565;
      }
      .status-indicator.loading {
        background: #ed8936;
      }

      .upload-area {
        border: 3px dashed #ddd;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        transition: all 0.3s ease;
        margin-bottom: 30px;
        cursor: pointer;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #4ecdc4;
        background: #f8fdff;
      }

      .upload-area.dragover {
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 4em;
        color: #ddd;
        margin-bottom: 20px;
      }

      .upload-area:hover .upload-icon,
      .upload-area.dragover .upload-icon {
        color: #4ecdc4;
      }

      .upload-text {
        font-size: 1.2em;
        color: #666;
        margin-bottom: 10px;
      }

      .upload-hint {
        color: #999;
        font-size: 0.9em;
      }

      .file-input {
        display: none;
      }

      .progress-container {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .progress-text {
        text-align: center;
        font-weight: 600;
        color: #495057;
      }

      .upload-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .info-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .info-number {
        font-size: 2em;
        font-weight: bold;
        color: #4ecdc4;
        margin-bottom: 5px;
      }

      .info-label {
        color: #666;
        font-size: 0.9em;
      }

      .log-container {
        margin-top: 30px;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-title {
        color: #4ecdc4;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .log-entry {
        color: #ccc;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.5;
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .log-entry.info {
        background: rgba(78, 205, 196, 0.1);
        color: #4ecdc4;
      }
      .log-entry.success {
        background: rgba(72, 187, 120, 0.1);
        color: #48bb78;
      }
      .log-entry.error {
        background: rgba(245, 101, 101, 0.1);
        color: #f56565;
      }
      .log-entry.warning {
        background: rgba(237, 137, 54, 0.1);
        color: #ed8936;
      }

      .service-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .service-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #ddd;
      }

      .service-card.nodejs {
        border-left-color: #68d391;
      }
      .service-card.python {
        border-left-color: #4fd1c7;
      }
      .service-card.java {
        border-left-color: #f56565;
      }

      .service-name {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 10px;
      }

      .service-url {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .service-info {
        color: #999;
        font-size: 0.8em;
      }

      .btn {
        background: #4ecdc4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        background: #44a08d;
        transform: translateY(-2px);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .status-indicator.loading {
        animation: pulse 1.5s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ BigUpload</h1>
        <p>‰ºÅ‰∏öÁ∫ßÂ§ßÊñá‰ª∂‰∏ä‰º†Ëß£ÂÜ≥ÊñπÊ°à - ‰∏âÂêéÁ´ØÊúçÂä°ÊµãËØï</p>
      </div>

      <div class="content">
        <!-- ÊúçÂä°Áä∂ÊÄÅÊ£ÄÊü• -->
        <div class="service-status" id="serviceStatus">
          <div class="service-card nodejs" id="nodejsCard">
            <div class="service-name">
              <span class="status-indicator loading" id="nodejsStatus"></span>
              Node.js ÊúçÂä°
            </div>
            <div class="service-url">http://localhost:3000</div>
            <div class="service-info" id="nodejsInfo">Ê£ÄÊü•‰∏≠...</div>
          </div>

          <div class="service-card python" id="pythonCard">
            <div class="service-name">
              <span class="status-indicator loading" id="pythonStatus"></span>
              Python ÊúçÂä°
            </div>
            <div class="service-url">http://localhost:5000</div>
            <div class="service-info" id="pythonInfo">Ê£ÄÊü•‰∏≠...</div>
          </div>

          <div class="service-card java" id="javaCard">
            <div class="service-name">
              <span class="status-indicator loading" id="javaStatus"></span>
              Java ÊúçÂä°
            </div>
            <div class="service-url">http://localhost:8080</div>
            <div class="service-info" id="javaInfo">Ê£ÄÊü•‰∏≠...</div>
          </div>
        </div>

        <!-- ÂêéÁ´ØÈÄâÊã©Âô® -->
        <div class="backend-selector">
          <div class="backend-option nodejs" data-backend="nodejs">
            <span class="status-indicator" id="indicator-nodejs"></span>
            Node.js Express
          </div>
          <div class="backend-option python" data-backend="python">
            <span class="status-indicator" id="indicator-python"></span>
            Python FastAPI
          </div>
          <div class="backend-option java" data-backend="java">
            <span class="status-indicator" id="indicator-java"></span>
            Java Spring Boot
          </div>
        </div>

        <!-- ‰∏ä‰º†Âå∫Âüü -->
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
          <div class="upload-hint">ÊîØÊåÅ‰ªªÊÑèÊñá‰ª∂Á±ªÂûãÔºåÊé®ËçêÊµãËØïÂ§ßÊñá‰ª∂(>10MB)</div>
          <input type="file" class="file-input" id="fileInput" multiple />
        </div>

        <!-- ËøõÂ∫¶ÊòæÁ§∫ -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">ÂáÜÂ§á‰∏ä‰º†...</div>
        </div>

        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="upload-info" id="uploadInfo" style="display: none">
          <div class="info-card">
            <div class="info-number" id="fileCount">0</div>
            <div class="info-label">Êñá‰ª∂Êï∞Èáè</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="totalSize">0</div>
            <div class="info-label">ÊÄªÂ§ßÂ∞è</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="uploadSpeed">0</div>
            <div class="info-label">‰∏ä‰º†ÈÄüÂ∫¶</div>
          </div>
          <div class="info-card">
            <div class="info-number" id="remainingTime">--</div>
            <div class="info-label">Ââ©‰ΩôÊó∂Èó¥</div>
          </div>
        </div>

        <!-- ÊéßÂà∂ÊåâÈíÆ -->
        <div style="text-align: center; margin: 20px 0">
          <button class="btn" id="testAllBtn">üî¨ ÊµãËØïÊâÄÊúâÊúçÂä°</button>
          <button class="btn" id="refreshBtn">üîÑ Âà∑Êñ∞Áä∂ÊÄÅ</button>
          <button class="btn" id="clearLogsBtn">üóëÔ∏è Ê∏ÖÁ©∫Êó•Âøó</button>
        </div>

        <!-- Êó•ÂøóÂÆπÂô® -->
        <div class="log-container">
          <div class="log-title">üìã ÂÆûÊó∂Êó•Âøó</div>
          <div id="logContent"></div>
        </div>
      </div>
    </div>

    <script>
      class BigUploadTester {
        constructor() {
          this.backends = {
            nodejs: {
              name: 'Node.js Express',
              url: 'http://localhost:3000',
              endpoints: {
                health: '/',
                verify: '/verify',
                upload: '/upload-chunk',
                merge: '/merge-chunks'
              }
            },
            python: {
              name: 'Python FastAPI',
              url: 'http://localhost:5000',
              endpoints: {
                health: '/api/upload/health',
                verify: '/api/upload/verify',
                upload: '/api/upload/upload',
                merge: '/api/upload/merge'
              }
            },
            java: {
              name: 'Java Spring Boot',
              url: 'http://localhost:8080',
              endpoints: {
                health: '/api/upload/health',
                verify: '/api/upload/verify',
                upload: '/api/upload/upload',
                merge: '/api/upload/merge'
              }
            }
          }

          this.currentBackend = 'nodejs'
          this.chunkSize = 2 * 1024 * 1024 // 2MB
          this.maxConcurrency = 3
          this.uploadStats = {
            startTime: 0,
            bytesUploaded: 0,
            totalBytes: 0,
            actualUploadStart: 0, // ÂÆûÈôÖÂºÄÂßã‰º†ËæìÁöÑÊó∂Èó¥
            lastUpdateTime: 0, // ‰∏äÊ¨°Êõ¥Êñ∞Êó∂Èó¥
            lastBytes: 0, // ‰∏äÊ¨°Êõ¥Êñ∞Êó∂ÁöÑÂ≠óËäÇÊï∞
            speedHistory: [] // ÈÄüÂ∫¶ÂéÜÂè≤ËÆ∞ÂΩïÔºàÁî®‰∫éÂπ≥ÊªëËÆ°ÁÆóÔºâ
          }

          this.init()
        }

        init() {
          this.bindEvents()
          this.checkAllServices()
          this.selectBackend('nodejs')
        }

        bindEvents() {
          // Êñá‰ª∂ÈÄâÊã©
          const fileInput = document.getElementById('fileInput')
          const uploadArea = document.getElementById('uploadArea')

          uploadArea.addEventListener('click', () => fileInput.click())
          fileInput.addEventListener('change', e =>
            this.handleFiles(e.target.files)
          )

          // ÊãñÊãΩ‰∏ä‰º†
          uploadArea.addEventListener('dragover', e => {
            e.preventDefault()
            uploadArea.classList.add('dragover')
          })

          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover')
          })

          uploadArea.addEventListener('drop', e => {
            e.preventDefault()
            uploadArea.classList.remove('dragover')
            this.handleFiles(e.dataTransfer.files)
          })

          // ÂêéÁ´ØÈÄâÊã©
          document.querySelectorAll('.backend-option').forEach(option => {
            option.addEventListener('click', () => {
              this.selectBackend(option.dataset.backend)
            })
          })

          // ÊåâÈíÆ‰∫ã‰ª∂
          document
            .getElementById('testAllBtn')
            .addEventListener('click', () => this.testAllServices())
          document
            .getElementById('refreshBtn')
            .addEventListener('click', () => this.checkAllServices())
          document
            .getElementById('clearLogsBtn')
            .addEventListener('click', () => this.clearLogs())
        }

        selectBackend(backend) {
          this.currentBackend = backend

          // Êõ¥Êñ∞UI
          document.querySelectorAll('.backend-option').forEach(option => {
            option.classList.remove('active')
          })
          document
            .querySelector(`[data-backend="${backend}"]`)
            .classList.add('active')

          this.log(`ÂàáÊç¢Âà∞ ${this.backends[backend].name}`, 'info')
        }

        async checkAllServices() {
          this.log('ÂºÄÂßãÊ£ÄÊü•ÊâÄÊúâÊúçÂä°Áä∂ÊÄÅ...', 'info')

          for (const [key, backend] of Object.entries(this.backends)) {
            await this.checkService(key, backend)
          }

          this.log('ÊúçÂä°Áä∂ÊÄÅÊ£ÄÊü•ÂÆåÊàê', 'success')
        }

        async checkService(key, backend) {
          const statusElement = document.getElementById(`${key}Status`)
          const infoElement = document.getElementById(`${key}Info`)
          const indicatorElement = document.getElementById(`indicator-${key}`)

          try {
            statusElement.className = 'status-indicator loading'
            indicatorElement.className = 'status-indicator loading'
            infoElement.textContent = 'Ê£ÄÊü•‰∏≠...'

            const response = await fetch(backend.url + backend.endpoints.health)

            if (response.ok) {
              const data = await response.json()
              statusElement.className = 'status-indicator online'
              indicatorElement.className = 'status-indicator online'
              infoElement.textContent = `‚úÖ Âú®Á∫ø - ${
                data.name || data.service || 'ÊúçÂä°Ê≠£Â∏∏'
              }`
              this.log(`${backend.name} ÊúçÂä°Ê≠£Â∏∏`, 'success')
            } else {
              throw new Error(`HTTP ${response.status}`)
            }
          } catch (error) {
            statusElement.className = 'status-indicator offline'
            indicatorElement.className = 'status-indicator offline'
            infoElement.textContent = `‚ùå Á¶ªÁ∫ø - ${error.message}`
            this.log(`${backend.name} ÊúçÂä°Á¶ªÁ∫ø: ${error.message}`, 'error')
          }
        }

        async testAllServices() {
          this.log('ÂºÄÂßãÊµãËØïÊâÄÊúâÊúçÂä°ÁöÑAPIÁ´ØÁÇπ...', 'info')

          for (const [key, backend] of Object.entries(this.backends)) {
            await this.testServiceEndpoints(key, backend)
          }

          this.log('ÊâÄÊúâÊúçÂä°ÊµãËØïÂÆåÊàê', 'success')
        }

        async testServiceEndpoints(key, backend) {
          this.log(`ÊµãËØï ${backend.name} ÁöÑAPIÁ´ØÁÇπ...`, 'info')

          // ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•
          try {
            const healthResponse = await fetch(
              backend.url + backend.endpoints.health
            )
            if (healthResponse.ok) {
              this.log(`  ‚úÖ ÂÅ•Â∫∑Ê£ÄÊü• OK`, 'success')
            } else {
              this.log(`  ‚ùå ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•: ${healthResponse.status}`, 'error')
            }
          } catch (error) {
            this.log(`  ‚ùå ÂÅ•Â∫∑Ê£ÄÊü•ÈîôËØØ: ${error.message}`, 'error')
          }

          // ÊµãËØïÊñá‰ª∂È™åËØÅÁ´ØÁÇπ
          try {
            const verifyData = {
              filename: 'test.txt',
              fileHash: 'test-hash-123',
              fileSize: 1024
            }

            const verifyResponse = await fetch(
              backend.url + backend.endpoints.verify,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(verifyData)
              }
            )

            if (
              verifyResponse.status === 200 ||
              verifyResponse.status === 404
            ) {
              this.log(`  ‚úÖ Êñá‰ª∂È™åËØÅÁ´ØÁÇπ OK`, 'success')
            } else {
              this.log(`  ‚ùå Êñá‰ª∂È™åËØÅÂ§±Ë¥•: ${verifyResponse.status}`, 'warning')
            }
          } catch (error) {
            this.log(`  ‚ùå Êñá‰ª∂È™åËØÅÈîôËØØ: ${error.message}`, 'error')
          }
        }

        async handleFiles(files) {
          if (files.length === 0) return

          this.log(`ÈÄâÊã©‰∫Ü ${files.length} ‰∏™Êñá‰ª∂`, 'info')

          // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
          const totalSize = Array.from(files).reduce(
            (sum, file) => sum + file.size,
            0
          )
          this.updateUploadInfo(files.length, totalSize)

          // ÂºÄÂßã‰∏ä‰º†Á¨¨‰∏Ä‰∏™Êñá‰ª∂
          if (files.length > 0) {
            await this.uploadFile(files[0])
          }
        }

        async uploadFile(file) {
          const backend = this.backends[this.currentBackend]
          this.log(
            `ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ${file.name} (${this.formatBytes(file.size)}) Âà∞ ${
              backend.name
            }`,
            'info'
          )

          // ÊòæÁ§∫ËøõÂ∫¶Êù°
          document.getElementById('progressContainer').style.display = 'block'
          this.uploadStats.startTime = Date.now()
          this.uploadStats.bytesUploaded = 0
          this.uploadStats.totalBytes = file.size

          try {
            // ËÆ°ÁÆóÊñá‰ª∂ÂìàÂ∏å
            this.updateProgress(0, 'ËÆ°ÁÆóÊñá‰ª∂ÂìàÂ∏å...')
            const fileHash = await this.calculateFileHash(file)
            this.log(`Êñá‰ª∂ÂìàÂ∏å: ${fileHash}`, 'info')

            // È™åËØÅÊñá‰ª∂
            this.updateProgress(5, 'È™åËØÅÊñá‰ª∂...')
            const verifyResult = await this.verifyFile(
              file.name,
              fileHash,
              file.size
            )

            if (verifyResult.exists) {
              this.updateProgress(100, 'Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåÁßí‰º†ÊàêÂäüÔºÅ')
              this.log('Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåÁßí‰º†ÊàêÂäüÔºÅ', 'success')
              return
            }

            // ÂàÜÁâá‰∏ä‰º†
            const chunks = Math.ceil(file.size / this.chunkSize)
            this.log(`Êñá‰ª∂Â∞ÜÂàÜ‰∏∫ ${chunks} ‰∏™ÂàÜÁâá`, 'info')

            // ÈáçÁΩÆ‰∏ä‰º†ÁªüËÆ°ÔºàÊéíÈô§ÂìàÂ∏åËÆ°ÁÆóÊó∂Èó¥Ôºâ
            this.uploadStats.actualUploadStart = 0
            this.uploadStats.lastUpdateTime = 0
            this.uploadStats.lastBytes = 0
            this.uploadStats.speedHistory = []

            for (let i = 0; i < chunks; i++) {
              const start = i * this.chunkSize
              const end = Math.min(start + this.chunkSize, file.size)
              const chunk = file.slice(start, end)

              this.updateProgress(
                ((i + 1) / chunks) * 90 + 5,
                `‰∏ä‰º†ÂàÜÁâá ${i + 1}/${chunks}...`
              )

              await this.uploadChunk(chunk, i, fileHash, file.name, chunks)

              this.uploadStats.bytesUploaded += chunk.size
              this.updateUploadSpeed()
            }

            // ÂêàÂπ∂ÂàÜÁâá
            this.updateProgress(98, 'ÂêàÂπ∂ÂàÜÁâá...')
            await this.mergeChunks(fileHash, file.name, chunks, file.size)

            this.updateProgress(100, '‰∏ä‰º†ÂÆåÊàêÔºÅ')
            this.log(`Êñá‰ª∂ ${file.name} ‰∏ä‰º†ÊàêÂäüÔºÅ`, 'success')
          } catch (error) {
            this.log(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'error')
            this.updateProgress(0, `‰∏ä‰º†Â§±Ë¥•: ${error.message}`)
          }
        }

        async calculateFileHash(file) {
          const hashBuffer = await crypto.subtle.digest(
            'SHA-256',
            await file.arrayBuffer()
          )
          const hashArray = Array.from(new Uint8Array(hashBuffer))
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        }

        async verifyFile(filename, fileHash, fileSize) {
          const backend = this.backends[this.currentBackend]
          const response = await fetch(backend.url + backend.endpoints.verify, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, fileHash, fileSize })
          })

          if (response.ok) {
            return await response.json()
          } else {
            return { exists: false, uploadedChunks: [] }
          }
        }

        async uploadChunk(chunk, chunkIndex, fileHash, filename, totalChunks) {
          const backend = this.backends[this.currentBackend]
          const formData = new FormData()

          formData.append('chunk', chunk)
          formData.append('chunkIndex', chunkIndex.toString())
          formData.append('fileHash', fileHash)

          // Java ÂêéÁ´ØÈúÄË¶ÅÁâπÊÆäÂèÇÊï∞
          if (this.currentBackend === 'java') {
            formData.append('fileName', filename)
            formData.append('fileId', fileHash) // ‰ΩøÁî® fileHash ‰Ωú‰∏∫ fileId
            formData.append('chunkTotal', totalChunks.toString())
          } else {
            formData.append('filename', filename)
          }

          const response = await fetch(backend.url + backend.endpoints.upload, {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error(`ÂàÜÁâá ${chunkIndex} ‰∏ä‰º†Â§±Ë¥•: ${response.status}`)
          }

          return await response.json()
        }

        async mergeChunks(fileHash, filename, totalChunks, fileSize) {
          const backend = this.backends[this.currentBackend]

          let requestBody
          if (this.currentBackend === 'java') {
            // Java ÂêéÁ´ØÈúÄË¶ÅÁâπÊÆäÂèÇÊï∞Ê†ºÂºè
            requestBody = {
              fileId: fileHash, // ‰ΩøÁî® fileHash ‰Ωú‰∏∫ fileId
              fileName: filename,
              fileHash: fileHash,
              chunkTotal: totalChunks,
              fileSize: fileSize
            }
          } else {
            // Node.js Âíå Python ÂêéÁ´Ø
            requestBody = {
              fileHash,
              filename,
              totalChunks
            }
          }

          const response = await fetch(backend.url + backend.endpoints.merge, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          })

          if (!response.ok) {
            throw new Error(`ÂàÜÁâáÂêàÂπ∂Â§±Ë¥•: ${response.status}`)
          }

          return await response.json()
        }

        updateProgress(percent, text) {
          document.getElementById('progressFill').style.width = `${percent}%`
          document.getElementById('progressText').textContent = text
        }

        updateUploadInfo(fileCount, totalSize) {
          document.getElementById('uploadInfo').style.display = 'grid'
          document.getElementById('fileCount').textContent = fileCount
          document.getElementById('totalSize').textContent =
            this.formatBytes(totalSize)
        }

        updateUploadSpeed() {
          const now = Date.now()

          // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°Êõ¥Êñ∞ÔºåËÆ∞ÂΩïÂÆûÈôÖÂºÄÂßã‰º†ËæìÊó∂Èó¥
          if (this.uploadStats.actualUploadStart === 0) {
            this.uploadStats.actualUploadStart = now
            this.uploadStats.lastUpdateTime = now
            this.uploadStats.lastBytes = 0
            return
          }

          // ËÆ°ÁÆóÁû¨Êó∂ÈÄüÂ∫¶ÔºàËøáÂéª1ÁßíÂÜÖÁöÑÈÄüÂ∫¶Ôºâ
          const timeDiff = (now - this.uploadStats.lastUpdateTime) / 1000
          const bytesDiff =
            this.uploadStats.bytesUploaded - this.uploadStats.lastBytes

          if (timeDiff > 0) {
            const instantSpeed = bytesDiff / timeDiff

            // Â∞ÜÁû¨Êó∂ÈÄüÂ∫¶Âä†ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩïÔºà‰øùÊåÅÊúÄËøë5‰∏™ËÆ∞ÂΩïÔºâ
            this.uploadStats.speedHistory.push(instantSpeed)
            if (this.uploadStats.speedHistory.length > 5) {
              this.uploadStats.speedHistory.shift()
            }

            // ËÆ°ÁÆóÂπ≥ÊªëÈÄüÂ∫¶ÔºàÊúÄËøëÂá†Ê¨°ÁöÑÂπ≥ÂùáÂÄºÔºâ
            const avgSpeed =
              this.uploadStats.speedHistory.reduce(
                (sum, speed) => sum + speed,
                0
              ) / this.uploadStats.speedHistory.length

            // ËÆ°ÁÆóÂâ©‰ΩôÊó∂Èó¥
            const remaining =
              avgSpeed > 0
                ? (this.uploadStats.totalBytes -
                    this.uploadStats.bytesUploaded) /
                  avgSpeed
                : Infinity

            // Êõ¥Êñ∞UI
            document.getElementById('uploadSpeed').textContent =
              this.formatBytes(avgSpeed) + '/s'
            document.getElementById('remainingTime').textContent =
              this.formatTime(remaining)

            // Êõ¥Êñ∞ËÆ∞ÂΩï
            this.uploadStats.lastUpdateTime = now
            this.uploadStats.lastBytes = this.uploadStats.bytesUploaded

            // Ë∞ÉËØïÊó•ÂøóÔºàÊØè5Ê¨°Êõ¥Êñ∞ËæìÂá∫‰∏ÄÊ¨°Ôºâ
            if (this.uploadStats.speedHistory.length === 5) {
              this.log(
                `ÂÆûÊó∂ÈÄüÂ∫¶: ${this.formatBytes(avgSpeed)}/s (Âü∫‰∫éÊúÄËøë${
                  this.uploadStats.speedHistory.length
                }Ê¨°ÊµãÈáè)`,
                'info'
              )
            }
          }
        }

        formatBytes(bytes) {
          if (bytes === 0) return '0 B'
          const k = 1024
          const sizes = ['B', 'KB', 'MB', 'GB']
          const i = Math.floor(Math.log(bytes) / Math.log(k))
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
          )
        }

        formatTime(seconds) {
          if (!isFinite(seconds)) return '--'
          const mins = Math.floor(seconds / 60)
          const secs = Math.floor(seconds % 60)
          return `${mins}:${secs.toString().padStart(2, '0')}`
        }

        log(message, type = 'info') {
          const logContent = document.getElementById('logContent')
          const timestamp = new Date().toLocaleTimeString()
          const logEntry = document.createElement('div')
          logEntry.className = `log-entry ${type}`
          logEntry.textContent = `[${timestamp}] ${message}`
          logContent.appendChild(logEntry)
          logContent.scrollTop = logContent.scrollHeight
        }

        clearLogs() {
          document.getElementById('logContent').innerHTML = ''
          this.log('Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫', 'info')
        }
      }

      // ÂàùÂßãÂåñÊµãËØïÂô®
      window.addEventListener('DOMContentLoaded', () => {
        new BigUploadTester()
      })
    </script>
  </body>
</html>
